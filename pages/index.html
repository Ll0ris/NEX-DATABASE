<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEX Database - Giriş</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="../assets/js/nodes.js" defer></script>
    <!-- Firebase v9+ Modular SDK -->
    <script type="module">
        // Import Firebase functions
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js';
        import { getFirestore, collection, doc, getDoc, setDoc, addDoc, getDocs, query, where } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js';
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCkCL0MJWOvv6cKCsnleL6EgIH1JsF_rzU",
            authDomain: "nex-database.firebaseapp.com",
            projectId: "nex-database",
            storageBucket: "nex-database.appspot.com",
            messagingSenderId: "532729129753",
            appId: "1:532729129753:web:4af9c4bb3ff18c9902f388"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Make functions global for use in other scripts
        window.firebaseApp = app;
        window.firestoreDb = db;
        window.firestoreFunctions = {
            collection,
            doc,
            getDoc,
            setDoc,
            addDoc,
            getDocs,
            query,
            where
        };
        
        console.log('Firebase initialized successfully!');
    </script>
</head>
<body>
    <canvas id="nodeCanvas"></canvas>
    <div class="background">
        <div class="container">
            <div class="login-panel">
                <div class="header">
                    <img src="../assets/images/logo.png" alt="NEX Logo" class="logo">
                    <h1>NEX DATABASE</h1>
                    <p class="subtitle">FSAC - Yıldız Teknik Üniversitesi</p>
                </div>
                
                <form class="login-form">
                    <div class="form-group">
                        <div class="input-container">
                            <i class="fas fa-user input-icon"></i>
                            <input type="text" id="username" name="username" placeholder="Kullanıcı Adı" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <div class="input-container">
                            <i class="fas fa-lock input-icon"></i>
                            <input type="password" id="password" name="password" placeholder="Şifre" required>
                        </div>
                    </div>
                    
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="remember" name="remember">
                        <label for="remember">Beni hatırla</label>
                    </div>
                    
                    <button type="submit" class="login-btn">
                        <i class="fas fa-sign-in-alt"></i> SİSTEME GİRİŞ
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Animated Error Bubble -->
    <div class="error-bubble" id="errorBubble">
        <span class="error-text">Kullanıcı adı veya şifre hatalı!</span>
    </div>
    
    <!-- Copyright Footer -->
    <footer class="copyright-footer">
        <p>&copy; 2025 NEX Database - FSAC Yıldız Teknik Üniversitesi. Tüm hakları saklıdır.</p>
    </footer>
    
    <!-- Yükleme Ekranı -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">Siteye yönlendiriliyorsunuz...</div>
        </div>
    </div>
    
    <script>
        // Disable session timer for login page
        window.DISABLE_SESSION_TIMER = true;

        // Basit user/user login - Firebase entegrasyonu ile
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.querySelector('.login-form');
            const errorBubble = document.getElementById('errorBubble');
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                const email = document.getElementById('username').value.trim(); // input id değişmediği için
                const password = document.getElementById('password').value.trim();
                const rememberMe = document.getElementById('remember').checked;

                // Firestore'da email ile arama
                checkUserByEmailInFirebase(email, password)
                .then(isValid => {
                    if (isValid) {
                        // Generate authentication token
                        const authToken = generateAuthToken(email);
                        
                        // "Beni hatırla" seçeneğine göre token süresi belirleme
                        let tokenExpiry;
                        if (rememberMe) {
                            // Beni hatırla aktifse 30 gün
                            tokenExpiry = Date.now() + (30 * 24 * 60 * 60 * 1000); // 30 gün
                            console.log('✅ Beni hatırla aktif - Token 30 gün geçerli');
                        } else {
                            // Beni hatırla kapalıysa 24 saat
                            tokenExpiry = Date.now() + (24 * 60 * 60 * 1000); // 24 saat
                            console.log('⚠️ Beni hatırla kapalı - Token 24 saat geçerli');
                        }
                        
                        // Store authentication data
                        localStorage.setItem('currentUserId', email);
                        localStorage.setItem('currentUserEmail', email);
                        localStorage.setItem('authToken', authToken);
                        localStorage.setItem('tokenExpiry', tokenExpiry.toString());
                        localStorage.setItem('isAuthenticated', 'true');
                        
                        // "Beni hatırla" seçeneği kontrolü
                        if (rememberMe) {
                            localStorage.setItem('rememberMe', 'true');
                            localStorage.setItem('rememberMeExpiry', (Date.now() + (30 * 24 * 60 * 60 * 1000)).toString()); // 30 gün sonra
                            console.log('✅ Beni hatırla seçeneği aktif - 30 gün kalıcı token');
                        } else {
                            localStorage.removeItem('rememberMe');
                            localStorage.removeItem('rememberMeExpiry');
                            console.log('⚠️ Beni hatırla seçili değil - 24 saat geçici token');
                        }
                        
                        // localStorage verilerini kontrol et
                        console.log('📊 Giriş sonrası localStorage:', {
                            authToken: localStorage.getItem('authToken') ? 'kaydedildi' : 'YOK',
                            tokenExpiry: localStorage.getItem('tokenExpiry'),
                            isAuthenticated: localStorage.getItem('isAuthenticated'),
                            currentUserId: localStorage.getItem('currentUserId')
                        });
                        
                        console.log('✅ Firestore giriş - Kullanıcı email ve token localStorage\'a kaydedildi:', email);
                        document.getElementById('loadingScreen').style.display = 'flex';
                        
                        // Daha uzun bekleme ve localStorage'ı tekrar kontrol
                        setTimeout(function() {
                            // Son kontrol
                            const finalCheck = localStorage.getItem('authToken');
                            console.log('🔍 Yönlendirme öncesi son localStorage kontrolü:', finalCheck ? 'VAR' : 'YOK');
                            
                            window.location.href = 'database.html';
                        }, 1500); // 1200'den 1500'e çıkardık
                    } else {
                        errorBubble.style.display = 'flex';
                        setTimeout(function() {
                            errorBubble.style.display = 'none';
                        }, 2000);
                    }
                })
                .catch(error => {
                    console.error('Giriş hatası:', error);
                    errorBubble.style.display = 'flex';
                    setTimeout(function() {
                        errorBubble.style.display = 'none';
                    }, 2000);
                });
            });
        });

        // Firebase kullanıcı kontrolü
        function checkUserByEmailInFirebase(email, password) {
            // Wait for Firebase to be ready
            if (!window.firestoreDb) {
                console.error('Firebase not ready yet');
                return Promise.reject(new Error('Firebase not ready'));
            }

            const { collection, query, where, getDocs } = window.firestoreFunctions;

            // Email ile sorgu
            const q = query(collection(window.firestoreDb, "users"), where("email", "==", email));
            return getDocs(q)
            .then(snapshot => {
                if (!snapshot.empty) {
                    const userData = snapshot.docs[0].data();
                    return userData.password === password;
                } else {
                    return false;
                }
            });
        }
        
        // Generate authentication token
        function generateAuthToken(email) {
            const timestamp = Date.now();
            const randomString = Math.random().toString(36).substring(2, 15);
            const tokenData = btoa(`${email}:${timestamp}:${randomString}`);
            return tokenData;
        }
        
        // Check if user is already authenticated
        function checkExistingAuth() {
            const authToken = localStorage.getItem('authToken');
            const tokenExpiry = localStorage.getItem('tokenExpiry');
            const isAuthenticated = localStorage.getItem('isAuthenticated');
            
            if (authToken && tokenExpiry && isAuthenticated === 'true') {
                const currentTime = Date.now();
                if (currentTime < parseInt(tokenExpiry)) {
                    // Token is still valid
                    console.log('✅ Geçerli token bulundu');
                    return true;
                } else {
                    // Token expired, clear auth data
                    clearAuthData();
                }
            }
            return false;
        }
        
        // Clear authentication data
        function clearAuthData() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('tokenExpiry');
            localStorage.removeItem('isAuthenticated');
            localStorage.removeItem('currentUserId');
            localStorage.removeItem('currentUserEmail');
        }
        
        // Giriş sayfasında admin mode'u sıfırla ve güvenli moda geç
        function resetToSafeMode() {
            localStorage.setItem('adminMode', 'safe');
            localStorage.setItem('adminModeText', 'Güvenli Mod');
            document.body.classList.remove('admin-user');
        }
        
        // Sayfa yüklendiğinde güvenli moda geç ve mevcut auth kontrolü yap
        document.addEventListener('DOMContentLoaded', function() {
            resetToSafeMode();
            
            // Check if user is already authenticated and remember me is enabled
            if (checkExistingAuth()) {
                const rememberMe = localStorage.getItem('rememberMe');
                const rememberMeExpiry = localStorage.getItem('rememberMeExpiry');
                
                if (rememberMe === 'true') {
                    // "Beni hatırla" aktif ama süresini kontrol et
                    if (rememberMeExpiry && Date.now() < parseInt(rememberMeExpiry)) {
                        // Beni hatırla süresi henüz dolmamış - direkt siteye yönlendir
                        const remainingDays = Math.ceil((parseInt(rememberMeExpiry) - Date.now()) / (24 * 60 * 60 * 1000));
                        console.log(`✅ Beni hatırla aktif - ${remainingDays} gün kaldı, direkt siteye yönlendiriliyor`);
                        document.getElementById('loadingScreen').style.display = 'flex';
                        setTimeout(function() {
                            window.location.href = 'database.html';
                        }, 800);
                        return;
                    } else {
                        // Beni hatırla süresi dolmuş - temizle
                        console.log('⚠️ Beni hatırla süresi dolmuş - veriler temizleniyor');
                        clearAuthData();
                    }
                } else {
                    // Beni hatırla aktif değil - token'ı temizle ve giriş formu göster
                    console.log('⚠️ Beni hatırla aktif değil - token temizleniyor');
                    clearAuthData();
                }
            }
            
            // Eğer buraya geldiyse, kullanıcı giriş yapmamış veya beni hatırla süresi dolmuş
            console.log('Kullanıcı giriş yapmamış veya beni hatırla süresi dolmuş, giriş formu gösteriliyor');
        });
    </script>
    <script src="../assets/js/global-features.js"></script>
</body>
</html>
