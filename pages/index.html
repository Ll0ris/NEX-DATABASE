<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEX Database - GiriÅŸ</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="../assets/js/nodes.js" defer></script>
    <!-- Firebase v9+ Modular SDK -->
    <script type="module">
        // Import Firebase functions
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js';
        import { getFirestore, collection, doc, getDoc, setDoc, addDoc, getDocs, query, where } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js';
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCkCL0MJWOvv6cKCsnleL6EgIH1JsF_rzU",
            authDomain: "nex-database.firebaseapp.com",
            projectId: "nex-database",
            storageBucket: "nex-database.appspot.com",
            messagingSenderId: "532729129753",
            appId: "1:532729129753:web:4af9c4bb3ff18c9902f388"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Make functions global for use in other scripts
        window.firebaseApp = app;
        window.firestoreDb = db;
        window.firestoreFunctions = {
            collection,
            doc,
            getDoc,
            setDoc,
            addDoc,
            getDocs,
            query,
            where
        };
        
        // Firebase initialized successfully
    </script>
</head>
<body>
    <canvas id="nodeCanvas"></canvas>
    <div class="background">
        <div class="container">
            <div class="login-panel">
                <div class="header">
                    <img src="../assets/images/logo.png" alt="NEX Logo" class="logo">
                    <h1>NEX DATABASE</h1>
                    <p class="subtitle">FSAC - YÄ±ldÄ±z Teknik Ãœniversitesi</p>
                </div>
                
                <form class="login-form">
                    <div class="form-group">
                        <div class="input-container">
                            <i class="fas fa-user input-icon"></i>
                            <input type="text" id="username" name="username" placeholder="KullanÄ±cÄ± AdÄ±" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <div class="input-container">
                            <i class="fas fa-lock input-icon"></i>
                            <input type="password" id="password" name="password" placeholder="Åžifre" required>
                        </div>
                    </div>
                    
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="remember" name="remember">
                        <label for="remember">Beni hatÄ±rla</label>
                    </div>
                    
                    <button type="submit" class="login-btn">
                        <i class="fas fa-sign-in-alt"></i> SÄ°STEME GÄ°RÄ°Åž
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Animated Error Bubble -->
    <div class="error-bubble" id="errorBubble">
        <span class="error-text">KullanÄ±cÄ± adÄ± veya ÅŸifre hatalÄ±!</span>
    </div>
    
    <!-- Copyright Footer -->
    <footer class="copyright-footer">
        <p>&copy; 2025 NEX Database - FSAC YÄ±ldÄ±z Teknik Ãœniversitesi. TÃ¼m haklarÄ± saklÄ±dÄ±r.</p>
    </footer>
    
    <!-- YÃ¼kleme EkranÄ± -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">Siteye yÃ¶nlendiriliyorsunuz...</div>
        </div>
    </div>
    
    <script>
        // Disable session timer for login page
        window.DISABLE_SESSION_TIMER = true;

        // Basit user/user login - Firebase entegrasyonu ile
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.querySelector('.login-form');
            const errorBubble = document.getElementById('errorBubble');
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                const email = document.getElementById('username').value.trim(); // input id deÄŸiÅŸmediÄŸi iÃ§in
                const password = document.getElementById('password').value.trim();
                const rememberMe = document.getElementById('remember').checked;

                // Firestore'da email ile arama
                checkUserByEmailInFirebase(email, password)
                .then(isValid => {
                    if (isValid) {
                        // Generate authentication token
                        const authToken = generateAuthToken(email);
                        
                        // "Beni hatÄ±rla" seÃ§eneÄŸine gÃ¶re token sÃ¼resi belirleme
                        let tokenExpiry;
                        if (rememberMe) {
                            // Beni hatÄ±rla aktifse 30 gÃ¼n
                            tokenExpiry = Date.now() + (30 * 24 * 60 * 60 * 1000); // 30 gÃ¼n
                        } else {
                            // Beni hatÄ±rla kapalÄ±ysa 24 saat
                            tokenExpiry = Date.now() + (24 * 60 * 60 * 1000); // 24 saat
                        }
                        
                        // Store authentication data
                        localStorage.setItem('currentUserId', email);
                        localStorage.setItem('currentUserEmail', email);
                        localStorage.setItem('authToken', authToken);
                        localStorage.setItem('tokenExpiry', tokenExpiry.toString());
                        localStorage.setItem('isAuthenticated', 'true');
                        
                        // "Beni hatÄ±rla" seÃ§eneÄŸi kontrolÃ¼
                        if (rememberMe) {
                            localStorage.setItem('rememberMe', 'true');
                            localStorage.setItem('rememberMeExpiry', (Date.now() + (30 * 24 * 60 * 60 * 1000)).toString()); // 30 gÃ¼n sonra
                        } else {
                            localStorage.removeItem('rememberMe');
                            localStorage.removeItem('rememberMeExpiry');
                        }
                        
                        document.getElementById('loadingScreen').style.display = 'flex';
                        
                        setTimeout(function() {
                            window.location.href = 'database.html';
                        }, 1500);
                    } else {
                        errorBubble.classList.remove('hide');
                        errorBubble.classList.add('show');
                        errorBubble.style.display = 'block';
                        setTimeout(function() {
                            errorBubble.classList.remove('show');
                            errorBubble.classList.add('hide');
                            setTimeout(() => {
                                errorBubble.style.display = 'none';
                            }, 400); // CSS transition sÃ¼resi
                        }, 3000); // 3 saniye gÃ¶ster
                    }
                })
                .catch(error => {
                    console.error('ðŸ”¥ GiriÅŸ hatasÄ±:', error);
                    errorBubble.classList.remove('hide');
                    errorBubble.classList.add('show');
                    errorBubble.style.display = 'block';
                    setTimeout(function() {
                        errorBubble.classList.remove('show');
                        errorBubble.classList.add('hide');
                        setTimeout(() => {
                            errorBubble.style.display = 'none';
                        }, 400);
                    }, 3000);
                });
            });
        });

        // Firebase kullanÄ±cÄ± kontrolÃ¼
        function checkUserByEmailInFirebase(email, password) {
            // Wait for Firebase to be ready with timeout
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 50;
                
                function waitForFirebase() {
                    if (window.firestoreDb && window.firestoreFunctions) {
                        // Firebase hazÄ±r, kullanÄ±cÄ± kontrolÃ¼ yap
                        performUserCheck(email, password, resolve, reject);
                    } else if (attempts < maxAttempts) {
                        attempts++;
                        setTimeout(waitForFirebase, 100);
                    } else {
                        reject(new Error('Firebase connection timeout'));
                    }
                }
                
                waitForFirebase();
            });
        }
        
        function performUserCheck(email, password, resolve, reject) {
            const { collection, query, where, getDocs } = window.firestoreFunctions;

            // Email ile sorgu (case insensitive iÃ§in toLowerCase kullan)
            const q = query(collection(window.firestoreDb, "users"), where("email", "==", email.toLowerCase()));
            getDocs(q)
            .then(snapshot => {
                if (!snapshot.empty) {
                    const userData = snapshot.docs[0].data();
                    resolve(userData.password === password);
                } else {
                    resolve(false);
                }
            })
            .catch(error => {
                reject(error);
            });
        }
        
        // Generate authentication token
        function generateAuthToken(email) {
            const timestamp = Date.now();
            const randomString = Math.random().toString(36).substring(2, 15);
            const tokenData = btoa(`${email}:${timestamp}:${randomString}`);
            return tokenData;
        }
        
        // Check if user is already authenticated
        function checkExistingAuth() {
            const authToken = localStorage.getItem('authToken');
            const tokenExpiry = localStorage.getItem('tokenExpiry');
            const isAuthenticated = localStorage.getItem('isAuthenticated');
            
            if (authToken && tokenExpiry && isAuthenticated === 'true') {
                const currentTime = Date.now();
                if (currentTime < parseInt(tokenExpiry)) {
                    // Token is still valid
                    // GeÃ§erli token bulundu
                    return true;
                } else {
                    // Token expired, clear auth data
                    clearAuthData();
                }
            }
            return false;
        }
        
        // Clear authentication data
        function clearAuthData() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('tokenExpiry');
            localStorage.removeItem('isAuthenticated');
            localStorage.removeItem('currentUserId');
            localStorage.removeItem('currentUserEmail');
        }
        
        // GiriÅŸ sayfasÄ±nda admin mode'u sÄ±fÄ±rla ve gÃ¼venli moda geÃ§
        function resetToSafeMode() {
            localStorage.setItem('adminMode', 'safe');
            localStorage.setItem('adminModeText', 'GÃ¼venli Mod');
            document.body.classList.remove('admin-user');
        }
        
        // Sayfa yÃ¼klendiÄŸinde gÃ¼venli moda geÃ§ ve mevcut auth kontrolÃ¼ yap
        document.addEventListener('DOMContentLoaded', function() {
            resetToSafeMode();
            
            // Check if user is already authenticated and remember me is enabled
            if (checkExistingAuth()) {
                const rememberMe = localStorage.getItem('rememberMe');
                const rememberMeExpiry = localStorage.getItem('rememberMeExpiry');
                
                if (rememberMe === 'true') {
                    // "Beni hatÄ±rla" aktif ama sÃ¼resini kontrol et
                    if (rememberMeExpiry && Date.now() < parseInt(rememberMeExpiry)) {
                        // Beni hatÄ±rla sÃ¼resi henÃ¼z dolmamÄ±ÅŸ - direkt siteye yÃ¶nlendir
                        document.getElementById('loadingScreen').style.display = 'flex';
                        setTimeout(function() {
                            window.location.href = 'database.html';
                        }, 800);
                        return;
                    } else {
                        // Beni hatÄ±rla sÃ¼resi dolmuÅŸ - temizle
                        clearAuthData();
                    }
                } else {
                    // Beni hatÄ±rla aktif deÄŸil - token'Ä± temizle ve giriÅŸ formu gÃ¶ster
                    clearAuthData();
                }
            }
            
            // EÄŸer buraya geldiyse, kullanÄ±cÄ± giriÅŸ yapmamÄ±ÅŸ veya beni hatÄ±rla sÃ¼resi dolmuÅŸ
        });
    </script>
    <script src="../assets/js/global-features.js"></script>
</body>
</html>
