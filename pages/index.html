<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEX Database - Giriş</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="../assets/js/nodes.js" defer></script>
    <!-- Firebase v9+ Modular SDK -->
    <script type="module">
        // Import Firebase functions
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js';
        import { getFirestore, collection, doc, getDoc, setDoc, addDoc, getDocs } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js';
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCkCL0MJWOvv6cKCsnleL6EgIH1JsF_rzU",
            authDomain: "nex-database.firebaseapp.com",
            projectId: "nex-database",
            storageBucket: "nex-database.appspot.com",
            messagingSenderId: "532729129753",
            appId: "1:532729129753:web:4af9c4bb3ff18c9902f388"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Make functions global for use in other scripts
        window.firebaseApp = app;
        window.firestoreDb = db;
        window.firestoreFunctions = {
            collection,
            doc,
            getDoc,
            setDoc,
            addDoc,
            getDocs
        };
        
        console.log('Firebase initialized successfully!');
    </script>
</head>
<body>
    <canvas id="nodeCanvas"></canvas>
    <div class="background">
        <div class="container">
            <div class="login-panel">
                <div class="header">
                    <img src="../assets/images/logo.png" alt="NEX Logo" class="logo">
                    <h1>NEX DATABASE</h1>
                    <p class="subtitle">FSAC - Yıldız Teknik Üniversitesi</p>
                </div>
                
                <form class="login-form">
                    <div class="form-group">
                        <div class="input-container">
                            <i class="fas fa-user input-icon"></i>
                            <input type="text" id="username" name="username" placeholder="Kullanıcı Adı" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <div class="input-container">
                            <i class="fas fa-lock input-icon"></i>
                            <input type="password" id="password" name="password" placeholder="Şifre" required>
                        </div>
                    </div>
                    
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="remember" name="remember">
                        <label for="remember">Beni hatırla</label>
                    </div>
                    
                    <button type="submit" class="login-btn">
                        <i class="fas fa-sign-in-alt"></i> SİSTEME GİRİŞ
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Animated Error Bubble -->
    <div class="error-bubble" id="errorBubble">
        <span class="error-text">Kullanıcı adı veya şifre hatalı!</span>
    </div>
    
    <!-- Copyright Footer -->
    <footer class="copyright-footer">
        <p>&copy; 2025 NEX Database - FSAC Yıldız Teknik Üniversitesi. Tüm hakları saklıdır.</p>
    </footer>
    
    <!-- Yükleme Ekranı -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">Siteye yönlendiriliyorsunuz...</div>
        </div>
    </div>
    
    <script>
        // Disable session timer for login page
        window.DISABLE_SESSION_TIMER = true;

        // Basit user/user login - Firebase entegrasyonu ile
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.querySelector('.login-form');
            const errorBubble = document.getElementById('errorBubble');
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value.trim();
                
                // Firebase'de kullanıcı kontrolü
                checkUserInFirebase(username, password)
                .then(isValid => {
                    if (isValid) {
                        // Giriş başarılı, kullanıcı ID'sini kaydet
                        localStorage.setItem('currentUserId', username);
                        document.getElementById('loadingScreen').style.display = 'flex';
                        setTimeout(function() {
                            window.location.href = 'database.html';
                        }, 1200);
                    } else {
                        // Hatalı giriş
                        errorBubble.style.display = 'flex';
                        setTimeout(function() {
                            errorBubble.style.display = 'none';
                        }, 2000);
                    }
                })
                .catch(error => {
                    console.error('Giriş hatası:', error);
                    errorBubble.style.display = 'flex';
                    setTimeout(function() {
                        errorBubble.style.display = 'none';
                    }, 2000);
                });
            });
        });

        // Firebase kullanıcı kontrolü
        function checkUserInFirebase(username, password) {
            // Wait for Firebase to be ready
            if (!window.firestoreDb) {
                console.error('Firebase not ready yet');
                return Promise.reject(new Error('Firebase not ready'));
            }
            
            const { doc, getDoc, setDoc } = window.firestoreFunctions;
            
            return getDoc(doc(window.firestoreDb, "users", username))
            .then(docSnap => {
                if (docSnap.exists()) {
                    const userData = docSnap.data();
                    return userData.password === password;
                } else {
                    // Eğer kullanıcı yoksa, basit user/user kontrolü yap ve oluştur
                    if (username === 'user' && password === 'user') {
                        // Varsayılan kullanıcıyı oluştur
                        return setDoc(doc(window.firestoreDb, "users", username), {
                            username: username,
                            password: password,
                            role: 'admin',
                            createdAt: new Date()
                        }).then(() => true);
                    }
                    return false;
                }
            });
        }
        
        // Giriş sayfasında admin mode'u sıfırla ve güvenli moda geç
        function resetToSafeMode() {
            localStorage.setItem('adminMode', 'safe');
            localStorage.setItem('adminModeText', 'Güvenli Mod');
            document.body.classList.remove('admin-user');
        }
        
        // Sayfa yüklendiğinde güvenli moda geç
        document.addEventListener('DOMContentLoaded', function() {
            resetToSafeMode();
        });
    </script>
    <script src="../assets/js/global-features.js"></script>
</body>
</html>
